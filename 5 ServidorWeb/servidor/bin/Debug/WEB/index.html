<!DOCTYPE html>
<html>
  <head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>WebCam</title>
    <script async src='opencv.js' onload='openCvReady();'></script>
    <script src='utils.js'></script>
    <style> 
      .label { color: white; padding: 8px; font-family: Arial; background-color: #ff9800; } 
      .center { margin-left: auto; margin-right: auto; }
    </style>
  </head>
  <body bgcolor="#000">
    <table class="center">
      <tr>
        <td>
          <table>
            <tr>
              <td><button id='capturar'>Capturar Foto</button></td>
              <td><button id='recapturar'>ReCapturar Foto</button></td>
              <td><button id='Enviar'>Usar Foto</button></td>
            </tr>
          </table>
          <br>
          <video id='cam_input' height='480' width='640'></video>
          <canvas id='canvas_output' height='480' width='640'></canvas>
          <canvas id='SALIDA'></canvas>
          <br><br>
          <table><tr><td><span id="estado" class="label">Iniciando</span></td></tr></table>
          <table><tr><td><span id="estado2" class="label">Foco No Capturada Correctamente</span></td></tr></table>
        </td>
      </tr>
    </table>
    <script>  
    function openCvReady(){
      cv['onRuntimeInitialized'] = () => {
        let video = document.getElementById('cam_input');
        document.getElementById("cam_input").style.display="none"; 
        document.getElementById("recapturar").style.display="none"; 
        document.getElementById("SALIDA").style.display="none"; 
        document.getElementById("Enviar").style.display="none";
        document.getElementById("estado2").style.display="none";
        navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(function (stream) {
          video.srcObject = stream;
          video.play();
        }).catch(function (err) { console.log('An error has occured! ' + err); });
        let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
        let gray = new cv.Mat();
        let cap = new cv.VideoCapture(cam_input);
        let faces = new cv.RectVector();
        let faceClassifier = new cv.CascadeClassifier();
        let utils = new Utils('errorMessage');
        let faceCascade = 'haarcascade_frontalface_default.xml';
        utils.createFileFromUrl(faceCascade, faceCascade, () => { faceClassifier.load(faceCascade); });
        const FPS = 30;
        function processVideo() {
          let begin = Date.now();
          cap.read(src);
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
          try {
            faceClassifier.detectMultiScale(gray, faces, 1.1, 3, 0);
              document.getElementById('estado').innerHTML = 'Facial no detectado';
              document.getElementById("estado").style.backgroundColor="#f44336";
            for (let i = 0; i < faces.size(); ++i) {
              let face = faces.get(i);
              let point1 = new cv.Point(face.x, face.y);
              let point2 = new cv.Point(face.x + face.width, face.y + face.height);
              cv.rectangle(src, point1, point2, [255, 0, 0, 255]);
              document.getElementById('estado').innerHTML = 'Facial detectado';
              document.getElementById("estado").style.backgroundColor="#04AA6D";
              document.getElementById('estado2').innerHTML = 'Foco Capturada';
              document.getElementById("estado2").style.backgroundColor="#04AA6D";
            }
          } catch (err) { 
            console.log(err); 
            document.getElementById('estado').innerHTML = 'Facial no detectado';
            document.getElementById("estado").style.backgroundColor="#f44336";
          }
          let rect = new cv.Rect(160, 0, 320, 480);
          dst = src.roi(rect);
          cv.imshow('canvas_output', dst);
          dst.delete();
          let delay = 1000 / FPS - (Date.now() - begin);
          setTimeout(processVideo, delay);
        }
      setTimeout(processVideo, 0);
    }
  }
  document.getElementById('capturar').onclick = function () {
    let cap = new cv.VideoCapture(cam_input);
    let video = document.getElementById('cam_input');
    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    cap.read(src);
    cv.imshow('SALIDA', src);
    let dst = new cv.Mat();
    let rect = new cv.Rect(160, 0, 320, 480);
    dst = src.roi(rect);
    cv.imshow('SALIDA', dst);
    src.delete();
    dst.delete();
    document.getElementById("canvas_output").style.display="none"; 
    document.getElementById("capturar").style.display="none"; 
    document.getElementById("recapturar").style.display="block"; 
    document.getElementById("SALIDA").style.display="block";
    document.getElementById("Enviar").style.display="block"; 
    document.getElementById("estado").style.display="none"; 
    document.getElementById("estado2").style.display="block"; 
  };
  document.getElementById('recapturar').onclick = function () {
    document.getElementById("canvas_output").style.display="block"; 
    document.getElementById("capturar").style.display="block"; 
    document.getElementById("recapturar").style.display="none"; 
    document.getElementById("SALIDA").style.display="none"; 
    document.getElementById("Enviar").style.display="none"; 
    document.getElementById("estado").style.display="block"; 
    document.getElementById("estado2").style.display="none";
  };
  document.getElementById('Enviar').onclick = function () {
    var can = document.getElementById('SALIDA');
    var ctx = can.getContext('2d');
    var img = new Image();
    img.src = can.toDataURL();
    //parent.postMessage(img.src, "*");
    //window.opener.postMessage(img.src, 'http://localhost:8080');
    window.opener.postMessage(img.src, "*");
  };
  </script>
</body>
</html>